<main class="product-detail">

  @if (isLoading()) {
    <div class="product-detail__loading">Cargando...</div>
  }

  @else if (product()) {
    <section class="product-detail__product" aria-labelledby="product-detail__title">

      <div class="product-detail__gallery-wrapper">

        <div class="product-detail__gallery-thumbs">
          @for (img of galleryImages(); track $index; let idx = $index) {
            <button type="button"
                    class="product-detail__gallery-thumb-wrapper"
                    [class.active]="selectedIndex() === idx"
                    (click)="setMainImage(idx)"
                    [attr.aria-label]="'Ver imagen ' + (idx + 1)">
              <img [src]="img" loading="lazy" alt="Miniatura {{ idx + 1 }}" class="product-detail__gallery-thumb">
            </button>
          }
        </div>

        <div class="product-detail__image-with-zoom">
          <div class="product-detail__gallery-main">
            <button type="button" class="product-detail__gallery-arrow product-detail__gallery-arrow--left"
                    (click)="prevImage()" aria-label="Imagen anterior">❮</button>

            <img #mainImage
                 [src]="selectedImage()"
                 [alt]="product()!.fldNombre"
                 class="product-detail__gallery-main-image"
                 (mousemove)="moveLens($event)"
                 (mouseenter)="createLens()"
                 (mouseleave)="removeLens()"
                 (click)="openLightbox()">

            <button type="button" class="product-detail__gallery-arrow product-detail__gallery-arrow--right"
                    (click)="nextImage()" aria-label="Imagen siguiente">❯</button>
          </div>

          <div #lens class="product-detail__zoom-lens" aria-hidden="true"></div>
          <div #result class="product-detail__zoom-result" aria-hidden="true"></div>
        </div>
      </div>

      <section class="product-detail__details product-detail__details--spaced">
        <h1 id="product-detail__title" class="product-detail__title">{{ product()!.fldNombre }}</h1>
        <p class="product-detail__price">${{ product()!.fldPrecio | number:'1.2-2' }}</p>

        <div class="product-detail__info">
          <h3 class="product-detail__specs-title">Detalles del producto</h3>
          <ul class="product-detail__specs-list">
            <li><strong>Marca:</strong> {{ product()!.fldMarca }}</li>
            <li><strong>Descripción:</strong> {{ product()!.descripcion }}</li>
            <li><strong>Disponibles:</strong> {{ product()!.unidades }} unidades</li>
          </ul>

          <div class="product-detail__cantidad">
            <label>Cantidad</label>
            <div class="product-detail__cantidad-control">
              <button type="button" (click)="decrementCantidad()" [disabled]="cantidad() <= 1">−</button>
              <input type="text" [value]="cantidad()" readonly />
              <button type="button" (click)="incrementCantidad()" [disabled]="cantidad() >= product()!.unidades">+</button>
            </div>
          </div>

          <div class="product-detail__actions">
            <button type="button" class="product-detail__btn product-detail__btn--primary"
                    (click)="addToCart()" [disabled]="product()!.unidades === 0">
              Agregar al Carrito
            </button>
          </div>
        </div>
      </section>

    </section>
  }

  @else {
    <div class="product-detail__error">Producto no encontrado.</div>
  }

  @if (showLightbox()) {
    <div class="product-detail__lightbox" (click)="closeLightbox()" role="dialog" aria-modal="true">
      <img class="product-detail__lightbox-image" [src]="selectedImage()" [alt]="product()?.fldNombre" />
    </div>
  }
</main>