<main class="product-detail">

  <ng-container *ngIf="isLoading(); else loadedContent">
    <div class="product-detail__loading" role="status" aria-live="polite">
      Cargando...
    </div>
  </ng-container>

  <ng-template #loadedContent>

    <ng-container *ngIf="product(); else notFound">

      <section class="product-detail__product" aria-labelledby="product-detail__title">

        <div class="product-detail__gallery-wrapper">

          <div class="product-detail__gallery-thumbs">
            <button *ngFor="let img of galleryImages(); let idx = index"
                    type="button"
                    class="product-detail__gallery-thumb-wrapper"
                    [class.active]="selectedIndex() === idx"
                    (click)="setMainImage(idx)"
                    [attr.aria-label]="'Ver imagen ' + (idx + 1)">
              <img [src]="img"
                   loading="lazy"
                   (error)="selectedImage.set('assets/img/no-image.jpg')"
                   [alt]="'Miniatura ' + (idx + 1) + ' de ' + galleryImages().length"
                   class="product-detail__gallery-thumb">
            </button>
          </div>

          <div class="product-detail__image-with-zoom">
            <div class="product-detail__gallery-main">
              <button type="button"
                      class="product-detail__gallery-arrow product-detail__gallery-arrow--left"
                      (click)="prevImage()"
                      aria-label="Imagen anterior">❮</button>

              <img #mainImage
                   [src]="selectedImage()"
                   [alt]="product()?.fldNombre || 'Imagen del producto'"
                   class="product-detail__gallery-main-image"
                   loading="lazy"
                   (mousemove)="moveLens($event)"
                   (mouseenter)="createLens()"
                   (mouseleave)="removeLens()"
                   (click)="openLightbox()"
                   (error)="selectedImage.set('assets/img/no-image.jpg')">

              <button type="button"
                      class="product-detail__gallery-arrow product-detail__gallery-arrow--right"
                      (click)="nextImage()"
                      aria-label="Imagen siguiente">❯</button>
            </div>

            <div #lens class="product-detail__zoom-lens" aria-hidden="true"></div>
            <div #result class="product-detail__zoom-result" aria-hidden="true"></div>
          </div>

        </div>

        <section class="product-detail__details" aria-labelledby="product-detail__title">
          <h1 id="product-detail__title" class="product-detail__title">
            {{ product()?.fldNombre || 'Sin nombre' }}
          </h1>

          <p class="product-detail__price" aria-label="Precio">
            ${{ product()?.fldPrecio | number:'1.2-2' }}
          </p>

          <div class="product-detail__info">

            <h3 class="product-detail__specs-title">Detalles del producto</h3>
            <ul class="product-detail__specs-list">
              <li><strong>Marca:</strong> {{ product()?.fldMarca || 'N/A' }}</li>
              <li><strong>Descripción:</strong> {{ product()?.descripcion || 'N/A' }}</li>
              <li><strong>Disponibles:</strong> {{ product()?.unidades ?? 0 }} unidades</li>
            </ul>

            <div class="product-detail__cantidad">
              <label for="cantidad-input">Cantidad</label>
              <div class="product-detail__cantidad-control">
                <button type="button"
                        (click)="decrementCantidad()"
                        [disabled]="cantidad() <= 1"
                        aria-label="Disminuir cantidad">−</button>

                <input id="cantidad-input"
                       type="text"
                       [value]="cantidad()"
                       readonly
                       aria-label="Cantidad seleccionada" />

                <button type="button"
                        (click)="incrementCantidad()"
                        [disabled]="cantidad() >= (product()?.unidades ?? 0)"
                        aria-label="Aumentar cantidad">+</button>
              </div>
            </div>

            <div class="product-detail__actions">
              <button type="button"
                      class="product-detail__btn product-detail__btn--primary"
                      (click)="addToCart(product()?.codigo_producto!)"
                      [disabled]="(product()?.unidades ?? 0) === 0"
                      aria-label="Agregar al carrito">
                Agregar al Carrito
              </button>
            </div>

          </div>
        </section>

      </section>

    </ng-container>

    <ng-template #notFound>
      <div class="product-detail__error" role="alert">
        Producto no encontrado.
      </div>
    </ng-template>

  </ng-template>

  <ng-container *ngIf="showLightbox()">
    <div class="product-detail__lightbox"
         (click)="closeLightbox()"
         role="dialog"
         aria-modal="true">
      <img class="product-detail__lightbox-image"
           [src]="selectedImage()"
           [alt]="product()?.fldNombre || 'Imagen del producto'"
           loading="lazy"
           (error)="selectedImage.set('assets/img/no-image.jpg')"/>
    </div>
  </ng-container>

</main>
